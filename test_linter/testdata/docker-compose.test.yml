x-common: &common
  image: ghcr.io/astral-sh/uv:python3.13-bookworm
  platform: linux/amd64

services:
  qodana-test-init:
    <<: *common
    command:
      - /bin/sh
      - -c
      - |
        set -e
        openssl req -x509 -newkey rsa:2048 \
          -keyout /tmp/mock_server.key -out /tmp/mock_server.crt \
          -days 3650 -nodes -subj "/CN=mocked.qodana.cloud" \
          -addext "subjectAltName=DNS:mocked.qodana.cloud,DNS:resources.jetbrains.com,DNS:analytics.services.jetbrains.com"
        chmod 600 /tmp/mock_server.key
        openssl pkcs12 -export -out /tmp/test-truststore.p12 \
          -inkey /tmp/mock_server.key -in /tmp/mock_server.crt \
          -passout pass:changeit -name mock-server
        mkdir -p /workspace/results
        cp -r /workspace/initial-results/. /workspace/results/
    volumes:
      - ./mocked-results:/workspace/initial-results:ro
      - qodana-workspace:/workspace
      - tmp-certs:/tmp

  qodana-test-mock:
    <<: *common
    container_name: qodana-test-mock
    depends_on:
      qodana-test-init:
        condition: service_completed_successfully
    entrypoint:
      - /bin/sh
      - -c
      - |
        unset SSL_CERT_FILE
        uv pip install --system flask
        export SSL_CERT_FILE=/tmp/mock_server.crt
        cat >> /etc/hosts << EOF
        127.0.0.1 mocked.qodana.cloud
        127.0.0.1 resources.jetbrains.com
        127.0.0.1 analytics.services.jetbrains.com
        EOF
        exec python3 /app/mock_server.py
    environment:
      - QODANA_TOKEN=Test123
      - QODANA_ENDPOINT=https://mocked.qodana.cloud
      - NONINTERACTIVE=1
      - CI=true
      - JAVA_TOOL_OPTIONS=-Djavax.net.ssl.trustStore=/tmp/test-truststore.p12 -Djavax.net.ssl.trustStorePassword=changeit -Djavax.net.ssl.trustStoreType=PKCS12
      - SSL_CERT_FILE=/tmp/mock_server.crt
    volumes:
      - ./mock_server.py:/app/mock_server.py:ro
      - qodana-workspace:/workspace
      - qodana-cache:/root/.cache
      - tmp-certs:/tmp
    working_dir: /workspace
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('https://127.0.0.1:443/health', context=__import__('ssl')._create_unverified_context())"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 60s
    cap_add:
      - NET_ADMIN

volumes:
  qodana-workspace:
  qodana-cache:
  tmp-certs:
