name: "Tests"
run-name: "Test (âš™ï¸ ${{ inputs.os }}, ðŸ³ ${{ inputs.container-engine }})"
on:
  workflow_call:
    inputs: &inputs
      os:
        type: string
        default: ubuntu-latest
        description: Runner OS
      container-engine:
        type: string
        default: docker@latest
        description: Container engine type and version. See .github/actions/setup-container-engine for more info.
    secrets:
      QODANA_LICENSE_ONLY_TOKEN:
        required: true
  workflow_dispatch:
    inputs: *inputs

jobs:
  test:
    name: Test
    runs-on: ${{ inputs.os }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup container engine
        uses: ./.github/actions/setup-container-engine
        with:
          version: ${{ inputs.container-engine }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          cache-dependency-path: "**/*.sum"
          go-version-file: go.mod

      - name: Set up Java 17 for config-loader-cli.jar
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - uses: ./.github/actions/mock-dependencies

      - name: Install test dependencies
        run: go install github.com/mfridman/tparse@latest

      - name: Build
        # Build everything that will be tested. Although go test performs a build itself, gotestfmt will panic on a
        # failed build.
        shell: bash
        run: |
          go generate -v ./...
          go build -v ./...

      - name: Export GOROOT and GOPATH
        shell: bash
        run: |
          echo "GOROOT=$(go env GOROOT)" >> "$GITHUB_ENV"
          echo "GOPATH=$(go env GOPATH)" >> "$GITHUB_ENV"

      - name: Run tests
        run: go test -v -json ./... -timeout 0 -coverpkg=./... -coverprofile=coverage-${{ inputs.os }}.out | tparse -all -follow
        env:
          QODANA_LICENSE_ONLY_TOKEN: ${{ secrets.QODANA_LICENSE_ONLY_TOKEN }}
          QODANA_TEST_CONTAINER: ${{ inputs.os == 'ubuntu-latest' && inputs.container-engine == 'docker@latest' && '1' || '' }}

      - name: Upload coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-${{ inputs.os }}-${{ inputs.container-engine }}
          path: coverage-${{ inputs.os }}.out
