# This file was generated by https://github.com/JetBrains/qodana-docker/blob/main/dockerfiles.py. DO NOT EDIT MANUALLY.

ARG BASE_TAG="bookworm-slim"
ARG NODE_TAG="22-bookworm-slim"
FROM node:$NODE_TAG AS node_base
ARG BASE_TAG="bookworm-slim"
FROM debian:$BASE_TAG
ARG DEBIAN_FRONTEND=noninteractive

ENV HOME="/root" \
    LC_ALL="en_US.UTF-8" \
    QODANA_DIST="/opt/idea" \
    QODANA_DATA="/data" \
    QODANA_DOCKER="true"

ENV JAVA_HOME="$QODANA_DIST/jbr" \
    QODANA_CONF="$HOME/.config/idea" \
    PATH="$QODANA_DIST/bin:$PATH"

# See also:
# https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-environment-variables#dotnet_root-dotnet_rootx86-dotnet_root_x86-dotnet_root_x64
# https://learn.microsoft.com/en-gb/dotnet/core/install/linux-scripted-manual#example
ENV DOTNET_ROOT="/usr/share/dotnet"
ENV PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"

# Not using the URL https://dot.net/v1/dotnet-install.sh because of https://github.com/dotnet/install-scripts/issues/276
ARG DOTNET_INSTALL_SH_REVISION="2e497bbe880cf47b209fe0d1f9c5e051916f830e"
ARG DOTNET_INSTALL_SH_SHA256="3f30fbfa69e182be7e60fd0cd9189c53cb61799b6077159fec74341112f1715e"
ARG DOTNET_CHANNELS="8.0 9.0 10.0"

RUN --mount=target=/var/lib/apt/lists,type=cache,sharing=locked \
    --mount=target=/var/cache/apt,type=cache,sharing=locked \
    bash <<-"EOF"
    set -euxo pipefail

    rm -f /etc/apt/apt.conf.d/docker-clean
    mkdir -m 777 -p "${QODANA_DATA}" "${QODANA_CONF}"

    apt-get update
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        fontconfig \
        default-jre \
        git \
        git-lfs \
        gnupg2 \
        locales \
        procps \
        software-properties-common

    echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen
    locale-gen

    echo 'root:x:0:0:root:/root:/bin/bash' > /etc/passwd
    chmod 666 /etc/passwd

    git config --global --add safe.directory '*'

    # Install .NET SDKs ------------------------------------------------------------------------------------------------
    # System dependencies (see https://learn.microsoft.com/en-gb/dotnet/core/install/linux-debian?tabs=dotnet10#dependencies)
    apt-get install -y --no-install-recommends \
        libc6 \
        libgcc-s1 \
        libgssapi-krb5-2 \
        libicu72 \
        libssl3 \
        libstdc++6 \
        zlib1g

    # Download and verify install script
    dotnet_install_sh_url="https://raw.githubusercontent.com/dotnet/install-scripts/$DOTNET_INSTALL_SH_REVISION/src/dotnet-install.sh"
    curl -L "$dotnet_install_sh_url" -o /tmp/dotnet-install.sh
    actual_sha256=$(sha256sum /tmp/dotnet-install.sh | cut -d ' ' -f1)
    if [ "$DOTNET_INSTALL_SH_SHA256" != "$actual_sha256" ]; then
        echo "SHA 256 did not match for $dotnet_install_sh_url"
        echo "  expected: $DOTNET_INSTALL_SH_SHA256"
        echo "    actual: $actual_sha256"
        exit 1
    fi

    # Install .NET SDKs
    chmod +x /tmp/dotnet-install.sh
    for channel in $DOTNET_CHANNELS; do
        /tmp/dotnet-install.sh --channel $channel --install-dir "$DOTNET_ROOT"
    done

    # Verify that requested SDKs are installed and available
    installed_sdks=$(dotnet --list-sdks)
    for channel in $DOTNET_CHANNELS; do
        if ! grep -Eq "^$channel" <<< "$installed_sdks"; then
            echo "Could not find requested channel $channel in the output of 'dotnet --list-sdks':"
            echo "$installed_sdks"
            exit 1
        fi
    done

    # ------------------------------------------------------------------------------------------------------------------
    chmod 777 -R "$DOTNET_ROOT" "$HOME"

    # Cleanup
    apt-get autoremove --purge -y
EOF

# renovate: datasource=npm depName=eslint
ENV ESLINT_VERSION="9.31.0"
# renovate: datasource=npm depName=pnpm
ENV PNPM_VERSION="10.13.1"

ENV PATH="/opt/yarn/bin:$PATH" RIDER_UNREAL_ROOT="/data/unrealEngine"
ENV SKIP_YARN_COREPACK_CHECK=0
COPY --from=node_base /usr/local/bin/node /usr/local/bin/
COPY --from=node_base /usr/local/include/node /usr/local/include/node
COPY --from=node_base /usr/local/lib/node_modules /usr/local/lib/node_modules
COPY --from=node_base /opt/yarn-* /opt/yarn/
RUN ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm && \
    ln -s /usr/local/lib/node_modules/npm/bin/npx-cli.js /usr/local/bin/npx && \
    ln -s /usr/local/lib/node_modules/corepack/dist/corepack.js /usr/local/bin/corepack && \
    node --version && \
    npm --version && \
    yarn --version && \
    npm install -g eslint@$ESLINT_VERSION pnpm@$PNPM_VERSION && npm config set update-notifier false && \
    mkdir -p $RIDER_UNREAL_ROOT && \
    chmod 777 -R "$HOME/.npm" "$HOME/.npmrc" && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        jq && \
    apt-get autoremove -y && apt-get clean

ARG QD_RELEASE=""
ENV QD_VERSION="2025.3" QD_IMAGE="dotnet"
ARG QD_CODE="QDNET"
ARG IDE_RELEASE_FEED="https://raw.githubusercontent.com/JetBrains/qodana-docker/refs/heads/main/feed/releases.json"
# hadolint ignore=DL3003,SC2043
RUN bash <<-"EOF"
    set -euxo pipefail

    dpkgArch="$(dpkg --print-architecture)"
    case "$dpkgArch" in
        "amd64")
            OS_ARCH_SUFFIX="";
            RELEASES_DIST_KEY="linux";
            ;;
        "arm64")
            OS_ARCH_SUFFIX="-aarch64";
            RELEASES_DIST_KEY="linuxARM64";
            ;;
        *) echo "Unsupported architecture $dpkgArch" >&2; exit 1 ;;
    esac

    if [ -z "$QD_RELEASE" ]; then
        case "$QD_CODE" in
            "QDNET")
                RELEASE_CODE="RD";
                ;;
            "QDGO")
                RELEASE_CODE="GO";
                ;;
            "QDJS")
                RELEASE_CODE="WS";
                ;;
            "QDJVM" | "QDAND")
                RELEASE_CODE="IIU";
                ;;
            "QDJVMC" | "QDANDC")
                RELEASE_CODE="IIC";
                ;;
            "QDPHP")
                RELEASE_CODE="PS";
                ;;
            "QDPY")
                RELEASE_CODE="PCP";
                ;;
            "QDPYC")
                RELEASE_CODE="PCC";
                ;;
            "QDCPP")
                RELEASE_CODE="CL";
                ;;
            *) echo "Unrecognized product code $QD_CODE" >&2; exit 1 ;;
        esac

        RELEASE_JSON=$(\
            curl -L $IDE_RELEASE_FEED |\
            jq "[\
                .[] |\
                select(.Code==\"$RELEASE_CODE\") |\
                .Releases |\
                sort_by(.Type, .Date) |\
                .[] |\
                select(.MajorVersion==\"$QD_VERSION\")\
            ] | .[-1]"\
        )
        if [ "$RELEASE_JSON" = "null" ]; then
            echo "No release found for $RELEASE_CODE ($QD_CODE) $QD_VERSION in $IDE_RELEASE_FEED" >&2 && exit 1
        fi
        QD_BUILD="$QD_CODE-$(echo "$RELEASE_JSON" | jq -r '.Build')"
        QD_NAME="qodana-$QD_BUILD$OS_ARCH_SUFFIX"
        QD_URL=$(echo "$RELEASE_JSON" | jq -r ".Downloads.$RELEASES_DIST_KEY.Link")
        QD_CHECKSUM_URL=$(echo "$RELEASE_JSON" | jq -r ".Downloads.$RELEASES_DIST_KEY.ChecksumLink")
    else
        QD_BUILD="$QD_CODE-$QD_RELEASE"
        QD_NAME="qodana-$QD_RELEASE$OS_ARCH_SUFFIX"
        QD_URL="https://download.jetbrains.com/qodana/$QD_VERSION/$QD_NAME.tar.gz"
        QD_CHECKSUM_URL="$QD_URL.sha256"
    fi

    curl -fsSL "$QD_URL" -o "/tmp/$QD_NAME.tar.gz"
               "$QD_CHECKSUM_URL" -o "/tmp/$QD_NAME.tar.gz.sha256"
               "$QD_CHECKSUM_URL.asc" -o "/tmp/$QD_NAME.tar.gz.sha256.asc"

    export GNUPGHOME="$(mktemp -d)"
    for key in "B46DC71E03FEEB7F89D1F2491F7A8F87B9D8F501"; do
        gpg --batch --keyserver "hkps://keys.openpgp.org" --recv-keys "$key" ||
        gpg --batch --keyserver "keyserver.ubuntu.com" --recv-keys "$key"
    done

    gpg --verify "/tmp/$QD_NAME.tar.gz.sha256.asc" "/tmp/$QD_NAME.tar.gz.sha256"
    echo "$(cat "/tmp/$QD_NAME.tar.gz.sha256" | awk '{ print $1 }') */tmp/$QD_NAME.tar.gz" | sha256sum --check
    mkdir -p /tmp/qd && tar -xzf "/tmp/$QD_NAME.tar.gz" --directory /tmp/qd
    mv /tmp/qd/qodana-QD* "$QODANA_DIST"
    chmod +x "$QODANA_DIST"/bin/*.sh "$QODANA_DIST"/bin/qodana
    update-alternatives --install /usr/bin/java java "$JAVA_HOME/bin/java" 0
    update-alternatives --install /usr/bin/javac javac "$JAVA_HOME/bin/javac" 0
    update-alternatives --set java "$JAVA_HOME/bin/java"
    update-alternatives --set javac "$JAVA_HOME/bin/javac"
    apt-get purge --auto-remove -y gnupg2
    rm -rf /var/cache/apt /var/lib/apt/ /tmp/* "$GNUPGHOME"
EOF


ARG PRIVILEGED="false"
ARG SUDO_SHA256="79eef9ec144c99809c3f037b17ec0936555d7e526ac0b2688eaa8b77e1452e4f"
RUN if [ "$PRIVILEGED" = "true" ]; then \
        apt-get update && \
        apt-get install -y sudo && \
        useradd -m -u 1001 -U qodana && \
        passwd -d qodana && \
        echo 'qodana ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
        chmod 777 /etc/passwd && \
        rm -rf /var/cache/apt /var/lib/apt/ /tmp/*; \
    else \
        curl -fsSL "https://raw.githubusercontent.com/JetBrains/qodana-docker/refs/heads/main/sudo" -o /usr/bin/sudo && \
        echo "${SUDO_SHA256} /usr/bin/sudo" > /tmp/sudo.shasum && \
        sha256sum --check --status /tmp/sudo.shasum && \
        chmod +x /usr/bin/sudo; \
    fi

LABEL maintainer="qodana-support@jetbrains.com" description="Qodana for .NET (https://jb.gg/qodana-dotnet)"
WORKDIR /data/project
ENTRYPOINT ["/opt/idea/bin/qodana"]